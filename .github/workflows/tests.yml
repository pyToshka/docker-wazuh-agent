name: Tests

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["CodeQL"]
    branches: [main]
    types:
      - completed
  pull_request:
    branches:
      - 'main'
      - 'release-*'

permissions: read-all

jobs:
  test-docker-build:
   runs-on: ubuntu-latest
   strategy:
      max-parallel: 12
      matrix:
        wazuh_agent_version: ['4.3.10-1', '4.4.5-1', '4.5.4-1', '4.6.0-1', '4.7.1-1', '4.7.2-1', '4.11.1-1', '4.14.1-1']
        dockerfile:
          - path: './Dockerfile'
            image: 'wazuh-agent-minideb'
          - path: './images/Dockerfile.amazonlinux'
            image: 'wazuh-agent-amazonlinux'
          - path: './images/Dockerfile.ubuntu'
            image: 'wazuh-agent-ubuntu'
        include:
          # Old agents: 4.7.0 cluster
          - wazuh_agent_version: '4.3.10-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.4.5-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.5.4-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.6.0-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.7.1-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.7.2-1'
            wazuh_cluster_version: '4.7.0'
          # New agents
          - wazuh_agent_version: '4.11.1-1'
            wazuh_cluster_version: '4.11.0'
          - wazuh_agent_version: '4.14.1-1'
            wazuh_cluster_version: '4.14.0'

   steps:
   - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

   - name: Set up QEMU
     uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

   - name: Set up Docker Buildx
     uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

   - name: Build Wazuh Agent image
     uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5.4.0
     with:
       context: .
       file: ${{ matrix.dockerfile.path }}
       build-args: AGENT_VERSION=${{ matrix.wazuh_agent_version }}
       tags: ${{ matrix.dockerfile.image }}:${{ matrix.wazuh_agent_version }}
       load: true
       cache-from: type=gha,scope=build-${{ matrix.dockerfile.image }}
       cache-to: type=gha,mode=max,scope=build-${{ matrix.dockerfile.image }}

   - name: Pull Wazuh cluster images
     run: |
        retry_pull() {
          local image=$1
          local max_attempts=3
          local attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Pulling $image (attempt $attempt/$max_attempts)..."
            if docker pull "$image"; then
              echo "Successfully pulled $image"
              return 0
            fi
            echo "Failed to pull $image, retrying in 10 seconds..."
            sleep 10
            attempt=$((attempt + 1))
          done
          echo "Failed to pull $image after $max_attempts attempts"
          return 1
        }
        retry_pull wazuh/wazuh-manager:${{ matrix.wazuh_cluster_version }}
        retry_pull wazuh/wazuh-indexer:${{ matrix.wazuh_cluster_version }}
        retry_pull wazuh/wazuh-dashboard:${{ matrix.wazuh_cluster_version }}

  pyunit-tests:
    runs-on: ubuntu-latest
    needs: ["test-docker-build"]
    strategy:
      max-parallel: 12
      matrix:
        wazuh_agent_version: ['4.3.10-1','4.4.5-1', '4.5.4-1', '4.6.0-1', '4.7.1-1', '4.7.2-1', '4.11.1-1', '4.14.1-1']
        include:
          - image: wazuh-agent-minideb
          - image: wazuh-agent-amazonlinux
          - image: wazuh-agent-ubuntu
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      with:
        fetch-depth: 0
    - name: Set up Python 3.10
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v6.1.0
      with:
        python-version: "3.10"
        cache: 'pip'
    - name: Install dependencies
      run: |
        pip install --require-hashes -r requirements-dev.txt
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Test with pytest
      run: |
        pytest -n auto -v --capture=sys -x --tb=long --junitxml=/tmp/test-results/wazuh-unittests-${{ matrix.wazuh_agent_version }}.xml
      env:
        AGENT_VERSION: "${{ matrix.wazuh_agent_version }}"

    - name: Upload Artifact
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: wazuh-unittests-${{ matrix.wazuh_agent_version }}
        path: /tmp/test-results/wazuh-unittests-${{ matrix.wazuh_agent_version }}.xml

  integrations-tests:
    permissions:
      contents: read
      issues: read
      checks: write
      pull-requests: write
    needs: ["pyunit-tests"]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        wazuh_agent_version: ['4.3.10-1', '4.4.5-1', '4.5.4-1', '4.6.0-1', '4.7.1-1', '4.7.2-1', '4.11.1-1', '4.14.1-1']
        image: ['wazuh-agent-minideb', 'wazuh-agent-amazonlinux', 'wazuh-agent-ubuntu']
        include:
          # Old agents: 4.7.0 cluster
          - wazuh_agent_version: '4.3.10-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.4.5-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.5.4-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.6.0-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.7.1-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.7.2-1'
            wazuh_cluster_version: '4.7.0'
          # New agents
          - wazuh_agent_version: '4.11.1-1'
            wazuh_cluster_version: '4.11.0'
          - wazuh_agent_version: '4.14.1-1'
            wazuh_cluster_version: '4.14.0'
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

    - name: Set up Python 3.10
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v6.1.0
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Set up QEMU
      uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

    - name: Install dependencies
      run: |
        pip install --require-hashes -r requirements-dev.txt

    - name: Download test results artifact
      uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
      with:
        name: wazuh-unittests-${{ matrix.wazuh_agent_version }}
        path: ${{ github.workspace }}/test-results/

    - name: Create single node certificates
      run: docker compose -f tests/single-node/generate-indexer-certs.yml run --rm generator

    - name: Setup Node
      run: |
        sudo sysctl -w vm.max_map_count=262144
        sudo chown -R 1000:1000 tests/single-node/config/wazuh_indexer_ssl_certs
        sudo find tests/single-node/config/wazuh_indexer_ssl_certs -type d -exec chmod 700 {} \;
        sudo find tests/single-node/config/wazuh_indexer_ssl_certs -type f -exec chmod 600 {} \;

    - name: Build minideb agent with cache
      uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5.4.0
      with:
        context: .
        file: ./Dockerfile
        build-args: AGENT_VERSION=${{ matrix.wazuh_agent_version }}
        tags: wazuh-agent-minideb:${{ matrix.wazuh_agent_version }}
        load: true
        cache-from: type=gha,scope=build-wazuh-agent-minideb
        cache-to: type=gha,mode=max,scope=build-wazuh-agent-minideb

    - name: Build amazonlinux agent with cache
      uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5.4.0
      with:
        context: .
        file: ./images/Dockerfile.amazonlinux
        build-args: AGENT_VERSION=${{ matrix.wazuh_agent_version }}
        tags: wazuh-agent-amazonlinux:${{ matrix.wazuh_agent_version }}
        load: true
        cache-from: type=gha,scope=build-wazuh-agent-amazonlinux
        cache-to: type=gha,mode=max,scope=build-wazuh-agent-amazonlinux

    - name: Build ubuntu agent with cache
      uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5.4.0
      with:
        context: .
        file: ./images/Dockerfile.ubuntu
        build-args: AGENT_VERSION=${{ matrix.wazuh_agent_version }}
        tags: wazuh-agent-ubuntu:${{ matrix.wazuh_agent_version }}
        load: true
        cache-from: type=gha,scope=build-wazuh-agent-ubuntu
        cache-to: type=gha,mode=max,scope=build-wazuh-agent-ubuntu

    - name: Pull Wazuh cluster images
      run: |
        retry_pull() {
          local image=$1
          local max_attempts=3
          local attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Pulling $image (attempt $attempt/$max_attempts)..."
            if docker pull "$image"; then
              echo "Successfully pulled $image"
              return 0
            fi
            echo "Failed to pull $image, retrying in 10 seconds..."
            sleep 10
            attempt=$((attempt + 1))
          done
          echo "Failed to pull $image after $max_attempts attempts"
          return 1
        }
        retry_pull wazuh/wazuh-manager:${{ matrix.wazuh_cluster_version }} &
        retry_pull wazuh/wazuh-indexer:${{ matrix.wazuh_cluster_version }} &
        retry_pull wazuh/wazuh-dashboard:${{ matrix.wazuh_cluster_version }} &
        wait

    - name: Start single node stack
      run: docker compose -f docker-compose.yml up -d
      env:
        AGENT_VERSION: "${{ matrix.wazuh_agent_version }}"
        WAZUH_CLUSTER_VERSION: "${{ matrix.wazuh_cluster_version }}"
      timeout-minutes: 30

    - name: Initialize Wazuh indexer security
      shell: bash
      run: |
        # Show container status
        echo "=== Container status ==="
        docker ps -a

        # Wait for indexer to be available on port 9200
        echo "Waiting for indexer port to be available..."
        PORT_AVAILABLE=false
        for i in {1..30}; do
          if curl -k -s "https://localhost:9200" >/dev/null 2>&1; then
            echo "Indexer port is available"
            PORT_AVAILABLE=true
            break
          fi
          echo "Waiting for indexer (attempt $i/30)..."
          # Show container status every 5 attempts
          if [ $((i % 5)) -eq 0 ]; then
            echo "=== Container status ==="
            docker ps -a | grep -E "wazuh|CONTAINER"
            echo "=== Indexer logs (last 20 lines) ==="
            docker compose logs wazuh.indexer --tail 20 2>&1 || true
          fi
          sleep 10
        done

        if [ "$PORT_AVAILABLE" = "false" ]; then
          echo "=== ERROR: Indexer port never became available ==="
          echo "=== Full indexer logs ==="
          docker compose logs wazuh.indexer 2>&1 || true
          echo "=== Skipping security initialization ==="
          exit 0
        fi

        # Debug: List certificate files
        echo "=== Certificate files in mounted volume ==="
        docker compose exec -T wazuh.indexer ls -la /usr/share/wazuh-indexer/config/certs/ 2>&1 || true

        # Debug: Show certificate subjects
        echo "=== Certificate chain verification ==="
        docker compose exec -T wazuh.indexer bash -c '
          echo "--- root-ca.pem subject ---"
          openssl x509 -in /usr/share/wazuh-indexer/config/certs/root-ca.pem -noout -subject -issuer 2>&1 || echo "Failed to read root-ca.pem"
          echo "--- wazuh.indexer.pem subject ---"
          openssl x509 -in /usr/share/wazuh-indexer/config/certs/wazuh.indexer.pem -noout -subject -issuer 2>&1 || echo "Failed to read wazuh.indexer.pem"
          echo "--- admin.pem subject (if exists) ---"
          openssl x509 -in /usr/share/wazuh-indexer/config/certs/admin.pem -noout -subject -issuer 2>&1 || echo "admin.pem not found or unreadable"
        ' || true

        # Run securityadmin.sh to initialize security index
        echo "Initializing security index with securityadmin.sh..."
        docker compose exec -T wazuh.indexer bash -c '
          # Find Java
          if [ -d "/usr/share/wazuh-indexer/jdk" ]; then
            export JAVA_HOME="/usr/share/wazuh-indexer/jdk"
          elif [ -d "/usr/lib/jvm/java-11-openjdk-amd64" ]; then
            export JAVA_HOME="/usr/lib/jvm/java-11-openjdk-amd64"
          fi
          export PATH="${JAVA_HOME}/bin:${PATH}"
          echo "Using JAVA_HOME: $JAVA_HOME"

          SECURITY_ADMIN="/usr/share/wazuh-indexer/plugins/opensearch-security/tools/securityadmin.sh"
          if [ -f "$SECURITY_ADMIN" ]; then
            chmod +x $SECURITY_ADMIN
            echo "Running securityadmin.sh..."
            # Use -icl to ignore cluster name and -nhnv to skip hostname verification
            $SECURITY_ADMIN \
              -cd /usr/share/wazuh-indexer/config/opensearch-security/ \
              -cacert /usr/share/wazuh-indexer/config/certs/root-ca.pem \
              -cert /usr/share/wazuh-indexer/config/certs/admin.pem \
              -key /usr/share/wazuh-indexer/config/certs/admin-key.pem \
              -h localhost \
              -p 9200 \
              -nhnv \
              -icl 2>&1
            RESULT=$?
            echo "securityadmin.sh exit code: $RESULT"
            if [ $RESULT -eq 0 ]; then
              echo "Security index initialized successfully"
            else
              echo "securityadmin.sh failed with exit code $RESULT"
            fi
          else
            echo "securityadmin.sh not found at $SECURITY_ADMIN, skipping initialization"
          fi
        ' || echo "Security initialization completed (may have warnings)"

    - name: Check Wazuh indexer start
      shell: bash
      run: |
        # Wait for Wazuh Indexer to be ready (max 5 minutes)
        # Accept both green and yellow status (yellow is normal for single-node clusters)
        for i in {1..30}; do
          HEALTH=$(curl -k -s "https://localhost:9200/_cluster/health" -u admin:SecretPassword 2>/dev/null || true)
          echo "Health response: $HEALTH"
          if echo "$HEALTH" | grep -qE '"status":"(green|yellow)"'; then
            STATUS=$(echo "$HEALTH" | grep -oE '"status":"[^"]+"' || true)
            echo "Wazuh indexer is ready! $STATUS"
            curl -k -s "https://localhost:9200/_cat/indices" -u admin:SecretPassword || true
            exit 0
          fi
          echo "Waiting for Wazuh indexer (attempt $i/30)..."
          # Print additional diagnostics every 5 attempts
          if [ $((i % 5)) -eq 0 ]; then
            echo "=== Cluster info ==="
            curl -k -s "https://localhost:9200/" -u admin:SecretPassword 2>/dev/null || true
            echo ""
            echo "=== Security plugin status ==="
            curl -k -s "https://localhost:9200/_opendistro/_security/health" -u admin:SecretPassword 2>/dev/null || true
            echo ""
          fi
          sleep 10
        done
        echo "=== TIMEOUT: Final diagnostics ==="
        echo "Cluster health:"
        curl -k -s "https://localhost:9200/_cluster/health" -u admin:SecretPassword 2>/dev/null || true
        echo ""
        echo "Indexer logs:"
        docker compose logs wazuh.indexer --tail 50 2>&1 || true
        exit 1

    - name: Integration test for Wazuh agent
      run: pytest  -v --capture=sys -x --tb=long .github/workflows/test_docker_compose.py --disable-warnings --junitxml=${{ github.workspace }}/test-results/wazuh-docker-compose-${{ matrix.wazuh_agent_version }}.xml

    - name: Print container logs
      if: failure()
      shell: bash
      run: |
        docker compose -f docker-compose.yml logs
        echo "=== API LOGS ==="
        docker compose -f docker-compose.yml exec -T wazuh.manager cat /var/ossec/logs/api.log || echo "api.log not found"
        echo "=== OSSEC LOGS ==="
        docker compose -f docker-compose.yml exec -T wazuh.manager cat /var/ossec/logs/ossec.log || echo "ossec.log not found"
        echo "=== PROCESSES ==="
        docker compose -f docker-compose.yml exec -T wazuh.manager ps aux || echo "ps failed"
        echo "=== NETWORK ==="
        docker compose -f docker-compose.yml exec -T wazuh.manager netstat -tulnp || echo "netstat failed"
        echo "=== API INSTALLED FILES ==="
        docker compose -f docker-compose.yml exec -T wazuh.manager ls -la /var/ossec/api/configuration/ || echo "ls failed"

    - name: Check results
      run: |
        ls -R ${{ github.workspace }}/test-results/

    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@34d7c956a59aed1bfebf31df77b8de55db9bbaaf # v2.21.0
      if: always()
      with:
         files: |
           test-results/**/*.xml

    - name: Stop containers and destroy
      if: always()
      run: docker compose -f docker-compose.yml down
