name: Tests

on:
  workflow_run:
    workflows: ["CodeQL"]
    branches: [main]
    types:
      - completed
  pull_request:
    branches:
      - 'main'
      - 'release-*'

permissions: read-all

jobs:
  test-docker-build:
   runs-on: ubuntu-latest
   strategy:
      max-parallel: 12
      matrix:
        wazuh_agent_version: ['4.3.10-1', '4.4.5-1', '4.5.4-1', '4.6.0-1', '4.7.1-1', '4.7.2-1', '4.11.1-1', '4.14.1-1']
        dockerfile:
          - path: './Dockerfile'
            image: 'wazuh-agent-minideb'
          - path: './images/Dockerfile.amazonlinux'
            image: 'wazuh-agent-amazonlinux'
          - path: './images/Dockerfile.ubuntu'
            image: 'wazuh-agent-ubuntu'
        include:
          # Old agents: 4.7.0 cluster
          - wazuh_agent_version: '4.3.10-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.4.5-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.5.4-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.6.0-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.7.1-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.7.2-1'
            wazuh_cluster_version: '4.7.0'
          # New agents
          - wazuh_agent_version: '4.11.1-1'
            wazuh_cluster_version: '4.11.0'
          - wazuh_agent_version: '4.14.1-1'
            wazuh_cluster_version: '4.14.0'

   steps:
   - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

   - name: Set up QEMU
     uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

   - name: Set up Docker Buildx
     uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

   - name: Build Wazuh Agent image
     uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5.4.0
     with:
       context: .
       file: ${{ matrix.dockerfile.path }}
       build-args: AGENT_VERSION=${{ matrix.wazuh_agent_version }}
       tags: ${{ matrix.dockerfile.image }}:${{ matrix.wazuh_agent_version }}
       load: true
       cache-from: type=gha,scope=build-${{ matrix.dockerfile.image }}
       cache-to: type=gha,mode=max,scope=build-${{ matrix.dockerfile.image }}

   - name: Pull Wazuh cluster images
     run: |
        docker pull wazuh/wazuh-manager:${{ matrix.wazuh_cluster_version }}
        docker pull wazuh/wazuh-indexer:${{ matrix.wazuh_cluster_version }}
        docker pull wazuh/wazuh-dashboard:${{ matrix.wazuh_cluster_version }}

  pyunit-tests:
    runs-on: ubuntu-latest
    needs: ["test-docker-build"]
    strategy:
      max-parallel: 12
      matrix:
        wazuh_agent_version: ['4.3.10-1','4.4.5-1', '4.5.4-1', '4.6.0-1', '4.7.1-1', '4.7.2-1', '4.11.1-1', '4.14.1-1']
        include:
          - image: wazuh-agent-minideb
          - image: wazuh-agent-amazonlinux
          - image: wazuh-agent-ubuntu
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      with:
        fetch-depth: 0
    - name: Set up Python 3.10
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v6.1.0
      with:
        python-version: "3.10"
        cache: 'pip'
    - name: Install dependencies
      run: |
        pip install --require-hashes -r requirements-dev.txt
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Test with pytest
      run: |
        pytest -n auto -v --capture=sys -x --tb=long --junitxml=/tmp/test-results/wazuh-unittests-${{ matrix.wazuh_agent_version }}.xml
      env:
        AGENT_VERSION: "${{ matrix.wazuh_agent_version }}"

    - name: Upload Artifact
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: wazuh-unittests-${{ matrix.wazuh_agent_version }}
        path: /tmp/test-results/wazuh-unittests-${{ matrix.wazuh_agent_version }}.xml

  integrations-tests:
    permissions:
      contents: read
      issues: read
      checks: write
      pull-requests: write
    needs: ["pyunit-tests"]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        wazuh_agent_version: ['4.3.10-1', '4.4.5-1', '4.5.4-1', '4.6.0-1', '4.7.1-1', '4.7.2-1', '4.11.1-1', '4.14.1-1']
        image: ['wazuh-agent-minideb', 'wazuh-agent-amazonlinux', 'wazuh-agent-ubuntu']
        include:
          # Old agents: 4.7.0 cluster
          - wazuh_agent_version: '4.3.10-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.4.5-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.5.4-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.6.0-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.7.1-1'
            wazuh_cluster_version: '4.7.0'
          - wazuh_agent_version: '4.7.2-1'
            wazuh_cluster_version: '4.7.0'
          # New agents
          - wazuh_agent_version: '4.11.1-1'
            wazuh_cluster_version: '4.11.0'
          - wazuh_agent_version: '4.14.1-1'
            wazuh_cluster_version: '4.14.0'
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

    - name: Set up Python 3.10
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v6.1.0
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Set up QEMU
      uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

    - name: Install dependencies
      run: |
        pip install --require-hashes -r requirements-dev.txt

    - name: Download test results artifact
      uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
      with:
        name: wazuh-unittests-${{ matrix.wazuh_agent_version }}
        path: ${{ github.workspace }}/test-results/

    - name: Free disk space
      run: docker system prune -a -f

    - name: Create single node certificates
      run: docker compose -f tests/single-node/generate-indexer-certs.yml run --rm generator

    - name: Setup Node
      run: |
        sudo sysctl -w vm.max_map_count=262144
        sudo chown -R 1000:1000 tests/single-node/config/wazuh_indexer_ssl_certs
        sudo find tests/single-node/config/wazuh_indexer_ssl_certs -type d -exec chmod 700 {} \;
        sudo find tests/single-node/config/wazuh_indexer_ssl_certs -type f -exec chmod 600 {} \;

    - name: Build minideb agent with cache
      uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5.4.0
      with:
        context: .
        file: ./Dockerfile
        build-args: AGENT_VERSION=${{ matrix.wazuh_agent_version }}
        tags: wazuh-agent-minideb:${{ matrix.wazuh_agent_version }}
        load: true
        cache-from: type=gha,scope=build-wazuh-agent-minideb
        cache-to: type=gha,mode=max,scope=build-wazuh-agent-minideb

    - name: Build amazonlinux agent with cache
      uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5.4.0
      with:
        context: .
        file: ./images/Dockerfile.amazonlinux
        build-args: AGENT_VERSION=${{ matrix.wazuh_agent_version }}
        tags: wazuh-agent-amazonlinux:${{ matrix.wazuh_agent_version }}
        load: true
        cache-from: type=gha,scope=build-wazuh-agent-amazonlinux
        cache-to: type=gha,mode=max,scope=build-wazuh-agent-amazonlinux

    - name: Build ubuntu agent with cache
      uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5.4.0
      with:
        context: .
        file: ./images/Dockerfile.ubuntu
        build-args: AGENT_VERSION=${{ matrix.wazuh_agent_version }}
        tags: wazuh-agent-ubuntu:${{ matrix.wazuh_agent_version }}
        load: true
        cache-from: type=gha,scope=build-wazuh-agent-ubuntu
        cache-to: type=gha,mode=max,scope=build-wazuh-agent-ubuntu

    - name: Pull Wazuh cluster images
      run: |
        docker pull wazuh/wazuh-manager:${{ matrix.wazuh_cluster_version }} &
        docker pull wazuh/wazuh-indexer:${{ matrix.wazuh_cluster_version }} &
        docker pull wazuh/wazuh-dashboard:${{ matrix.wazuh_cluster_version }} &
        wait

    - name: Start single node stack
      run: docker compose -f docker-compose.yml up -d
      env:
        AGENT_VERSION: "${{ matrix.wazuh_agent_version }}"
        WAZUH_CLUSTER_VERSION: "${{ matrix.wazuh_cluster_version }}"
      timeout-minutes: 10

    - name: Check Wazuh indexer start
      shell: bash
      run: |
        # Wait for Wazuh Indexer to be ready (max 5 minutes)
        for i in {1..30}; do
          if curl -k -s "https://localhost:9200/_cluster/health" -u admin:SecretPassword | grep -q "green"; then
            echo "Wazuh indexer is green!"
            curl -k -s "https://localhost:9200/_cat/indices" -u admin:SecretPassword
            exit 0
          fi
          echo "Waiting for Wazuh indexer (attempt $i/30)..."
          sleep 10
        done
        echo "Timeout waiting for Wazuh indexer"
        exit 1

    - name: Integration test for Wazuh agent
      run: pytest  -v --capture=sys -x --tb=long .github/workflows/test_docker_compose.py --disable-warnings --junitxml=${{ github.workspace }}/test-results/wazuh-docker-compose-${{ matrix.wazuh_agent_version }}.xml

    - name: Print container logs
      if: failure()
      shell: bash
      run: |
        docker compose -f docker-compose.yml logs
        echo "=== API LOGS ==="
        docker compose -f docker-compose.yml exec -T wazuh.manager cat /var/ossec/logs/api.log || echo "api.log not found"
        echo "=== OSSEC LOGS ==="
        docker compose -f docker-compose.yml exec -T wazuh.manager cat /var/ossec/logs/ossec.log || echo "ossec.log not found"
        echo "=== PROCESSES ==="
        docker compose -f docker-compose.yml exec -T wazuh.manager ps aux || echo "ps failed"
        echo "=== NETWORK ==="
        docker compose -f docker-compose.yml exec -T wazuh.manager netstat -tulnp || echo "netstat failed"
        echo "=== API INSTALLED FILES ==="
        docker compose -f docker-compose.yml exec -T wazuh.manager ls -la /var/ossec/api/configuration/ || echo "ls failed"

    - name: Check results
      run: |
        ls -R ${{ github.workspace }}/test-results/

    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@34d7c956a59aed1bfebf31df77b8de55db9bbaaf # v2.21.0
      if: always()
      with:
         files: |
           test-results/**/*.xml

    - name: Stop containers and destroy
      if: always()
      run: docker compose -f docker-compose.yml down
